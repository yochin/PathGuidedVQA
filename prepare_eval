import os
import json
import argparse

from tools import read_gt_pair_from_xml
import pdb


def parse_args():
     parser = argparse.ArgumentParser(
        description='Generate json file for the llava training framework')

     parser.add_argument(
         '--gt-dir', metavar='DIRECTORY for xml files', 
         help='directory which contains images and object properties')
     
     parser.add_argument(
         '--output', metavar='FILEPATH', 
         help='path for an output json file')

     return parser.parse_args()
     

def main():
    args = parse_args()
    args.gt_dir = '../output_t4/qa'
    args.output = '../eval_clipscore/t4.json'

    files = os.listdir(args.gt_dir)
    xml_files = [f for f in files if f.endswith(('.xml'))]

    list_removal = ['<|startoftext|>', '<|im_end|>', '[!@#$NEXT!@#$]']
    # list_actions = ['go left 45 degree', 'go straight', 'go right 45 degree', 'stop']


    # first parsing, then print
    # go 0: we suggest the user go forward because ...
    # 

    res = {}
    for xml_file in xml_files:
        xml_path = os.path.join(args.gt_dir, xml_file)
        img_filename, answer = read_gt_pair_from_xml(xml_path)

        img_filename_only = os.path.splitext(img_filename)[0]

        # parsing
        for rem in list_removal:
            answer = answer.replace(rem, '')

        res[img_filename_only] = answer

    with open(args.output, 'w', encoding='utf-8') as json_file:
        json.dump(res, json_file, indent="\t", ensure_ascii=False)

    return
   

if __name__ == '__main__':
    main()